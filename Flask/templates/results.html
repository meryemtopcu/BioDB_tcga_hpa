
{% extends "base.html" %}
{% block title %}Results – My BioDB{% endblock %}

{% block content %}

<div class="my-4">

    <!-- When there`s no result-------------------------------------------------------------------------------->
    {% if (hpa is none) and (tcga_rows|length == 0) %}
         <div class="alert alert-warning" role="alert">
            No data found for gene: <strong>{{ gene_id }}</strong>.
        </div>
    {% else %}


        {# data sources  (template-level flags) #}
        {% set has_hpa = (hpa is not none) %}
        {% set has_tcga = (tcga_rows|length > 0) %}


<!-- ========================================================================================================================================================================= -->


<!-- =========================================================================================================================================================================
     1 INFO GRAPH LIKE DATA
     ========================= -->
        <div class="row mb-4">
            <div class="col-md-8 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-1">
                            Gene: <span class="text-primary">{{ gene_name }}</span>
                        </h5>
                        <p class="mb-2 text-muted">
                            Gene ID: <code>{{ gene_id }}</code>
                        </p>

                        <p class="mb-2">
                            <span class="badge badge-{{ 'success' if has_hpa else 'secondary' }} mr-2">
                                HPA – Protein expression {{ 'available' if has_hpa else 'not available' }}
                            </span>
                            <span class="badge badge-{{ 'info' if has_tcga else 'secondary' }}">
                                TCGA – RNA expression {{ 'available' if has_tcga else 'not available' }}
                            </span>
                        </p>

                        <p class="mb-0 small text-muted">
                            This view combines <strong>protein levels</strong> from the Human Protein Atlas (HPA)
                            and <strong>RNA-seq expression</strong> from TCGA-BRCA for the same gene.
                        </p>
                    </div>
                </div>
            </div>

            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">Database snapshot</h6>
                        <ul class="small mb-1 pl-3">
                            <li>HPA table: protein expression per cancer type (High/Medium/Low/Not detected).</li>
                            <li>TCGA table: RNA-seq counts (unstranded / stranded) for BRCA samples.</li>
                        </ul>
                        <p class="small text-muted mb-0">
                            You are currently viewing the combined profile for:
                            <strong>{{gene_name }}</strong>.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2) Graps: HPA & TCGA ------------------------------------------------------->
        <div class="row mb-4">
            {% if has_hpa %}
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        Protein expression (HPA)
                    </div>
                    <div class="card-body">
                        <canvas id="proteinChart"></canvas>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if has_tcga %}
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        RNA expression (TCGA)
                    </div>
                    <div class="card-body">
                        <canvas id="rnaChart"></canvas>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

<!-- ========================================================================================================================================================================= -->


<!-- =========================================================================================================================================================================
     DETAILED TABLES
     ========================= -->
<div class="card">
  <div class="card-header">
    Detailed view (HPA + TCGA)
  </div>

  <div class="card-body">
    <div class="table-responsive">

      <!-- HPA TABLE (single row)  --------------------------------------------------------------------->
      {% if has_hpa %}
      <h6 class="mb-2">HPA (protein)</h6>

      <table class="table table-bordered table-sm mb-4">
        <thead class="thead-light">
          <tr>
            <th>Gene ID</th>
            <th>Gene Name</th>
            <th>High</th>
            <th>Medium</th>
            <th>Low</th>
            <th>Not detected</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <td>{{ hpa[0] }}</td>
            <td>{{ hpa[1] }}</td>
            <td>{{ hpa[3] }}</td>
            <td>{{ hpa[4] }}</td>
            <td>{{ hpa[5] }}</td>
            <td>{{ hpa[6] }}</td>
          </tr>
        </tbody>
      </table>
      {% endif %}

      <!-----------TCGA TABLE (many rows)---------------------------------------------------------------------------------->
      {% if has_tcga %}
      <h6 class="mb-2">TCGA (RNA) – rows for this gene_id</h6>

      <table class="table table-bordered table-sm mb-0">
        <thead class="thead-light">
          <tr>
            <th>Sample ID</th>
            <th>Unstranded</th>
            <th>Stranded 1st</th>
            <th>Stranded 2nd</th>
            <th>TPM (unstranded)</th>
            <th>FPKM (unstranded)</th>
            <th>FPKM-UQ (unstranded)</th>
          </tr>
        </thead>

        <tbody>
          {% for r in tcga_rows %}
          <tr>
            <td>{{ r[0] }}</td>   <!-- sample_id -->
            <td>{{ r[3] }}</td>   <!-- unstranded -->
            <td>{{ r[4] }}</td>   <!-- stranded_first -->
            <td>{{ r[5] }}</td>   <!-- stranded_second -->
            <td>{{ r[6] }}</td>   <!-- tpm_unstranded -->
            <td>{{ r[7] }}</td>   <!-- fpkm_unstranded -->
            <td>{{ r[8] }}</td>   <!-- fpkm_uq_unstranded -->
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}

      <!-- NO DATA FALLBACK ------------------------------------>
      {% if (not has_hpa) and (not has_tcga) %}
        <div class="alert alert-warning mb-0" role="alert">
          No HPA or TCGA rows found for <code>{{ gene_id }}</code>.
        </div>
      {% endif %}

    </div> <!-- /table-responsive -->
  </div> <!-- /card-body -->
</div> <!-- /card -->
  <!--========================================================================================================================================================================  --> 



<!-- =========================================================================================================================================================================
     EXTERNAL LINKS BLOCK
     ========================= -->
        <div class="mt-3">
            <h2 class="h6">External resources for {{ gene_name }}</h2>

            <ul class="mb-0">
                <li>
                    <a href="https://www.ncbi.nlm.nih.gov/gene/?term={{ gene_name }}"
                       target="_blank" rel="noopener noreferrer">
                        Search {{ gene_name }} on NCBI Gene
                    </a>
                </li>

                <li>
                    <a href="https://www.proteinatlas.org/search/{{ gene_name }}"
                       target="_blank" rel="noopener noreferrer">
                        Search {{ gene_name }} on Human Protein Atlas
                    </a>
                </li>

                <li>
                    <a href="https://www.ensembl.org/Multi/Search/Results?q={{ gene_name }};site=ensembl"
                       target="_blank" rel="noopener noreferrer">
                        Search {{ gene_name }} on Ensembl
                    </a>
                </li>
            </ul>
        </div>
        <!-- END OF EXTERNAL LINKS BLOCK ------------------------------------------>

{% endif %}

</div>   {# closes <div class="my-4"> #}
{% endblock %}  {# closes block content #}

<!-- ========================================================================================================================================================================= -->



{% block scripts %}
<!-- =========================================================================================================================================================================
     DATA > CHART
     ========================= -->    

{% if (hpa_chart is not none) or (tcga_chart is not none) %}
<script>
  // ---------- HPA chart ----------
  {% if hpa_chart is not none %}
  (function () {
    var ctx = document.getElementById('proteinChart').getContext('2d');

    var labels = {{ hpa_chart["labels"] | tojson }};
    var values = {{ hpa_chart["values"] | tojson }};

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Protein expression (HPA)',
          data: values
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  })();
  {% endif %}

  // ---------- TCGA chart (TPM per sample) ----------
  {% if tcga_chart is not none %}
  (function () {
    var ctx = document.getElementById('rnaChart').getContext('2d');

    var labels = {{ tcga_chart["labels"] | tojson }};
    var values = {{ tcga_chart["values"] | tojson }};

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'TPM (unstranded) – mean per sample',
          data: values
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  })();
  {% endif %}
</script>
{% endif %}
{% endblock %}
